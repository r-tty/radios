--------------------------------------------------------------------------------
  rd001_01.txt - RadiOS documentation file.

                 Description: RadiOS Module Format.
                 Version: 0.01
                 Document type: plain text, CR/LF
                 Language: Russian, CP866
                 Copyright: (c) 1999 Yuri Zaporogets.
--------------------------------------------------------------------------------

               Формат модуля операционной системы Radios.

 1. Введение.

 В ОС RadiOS 0.01 используются три типа модулей:
  - исполняемые (executable) - представляют собой файл, содержащий исполняемый
    двоичный код процессора 80386, а также данные и переменные;
  - библиотечные (library) - файл, содержащий набор данных и полностью
    реентрабельных процедур. Библиотечные модули загружаются в разделяемую
    память и могут использоваться несколькими процессами (разделяемые
    библиотеки);
  - модули данных (data) - содержат в себе только неизменяемые данннные, в т.ч.
    данные-ресурсы (поддержка ресурсов пока не реализована).


 2. Заголовок модуля.

 В начале каждого модуля расположен заголовок. Структура его представлена ниже:

 ; --- Misc. definitions ---
 MaxModNameLen		EQU		15	; Max. module name length
 MaxSymNameLen		EQU		255	; Max. symbolic name length

 ; --- Module header structure ---
 struc tModuleHdr
  Signature	DD	?		; Signature
  MiscFlags	DB	?		; Miscellaneous flags
  TargetOS	DB	?		; Target OS type
  OS_Version	DW	?		; Target OS version
  ImportTblOfs	DD	?		; Import table offset
  ExportTblOfs	DD	?		; Export table offset
  ResourceTblOfs DD	?		; Resource table offset
  RelocTblOfs	DD	?		; Relocation table offset
  ConfigTblOfs	DD	?		; Configuration table offset
  SectionsOfs	DD	?		; Offset to sections begin
  CodeSectSize	DD	?		; Code section size
  DataSectSize	DD	?		; Data section size
  VarSectSize	DD	?		; Variables section size
  StackSize	DD	?		; Stack size
  EntryPoint	DD	?		; Startup entry point
  ModName	DB	MaxModNameLen dup (?)
  Reserved	DD	?,?
 ends

 Описание полей заголовка:

  Signature (DWORD) - сигнатура модуля. Для каждого типа модуля определена
   собственная сигнатура:

    004D5852h ("RXM",0) - исполняемый модуль;
    004D4C52h ("RLM",0) - библиотечный модуль;
    004D4452h ("RDM",0) - модуль данных.

  MiscFlags (BYTE) - различные битовые флаги. Пока это поле зарезервировано.

  TargetOS (BYTE) - тип операционной системы, под управлением которой должен
   быть загружен модуль. Поле должно быть установлено в 1.

  OS_Version (WORD) - версия ОС, на которую рассчитан модуль. Для версии 0.01
   старший байт=0, младший байт=1.

  ImportTblOfs (DWORD) - смещение в байтах от начала модуля до таблицы
   импортируемых имен (см. ниже).

  ExportTblOfs (DWORD) - смещение в байтах от начала модуля до таблицы
   экспортируемых имен (см. ниже).

  ResourceTblOfs (DWORD) - смещение в байтах от начала модуля до таблицы
   ресурсов (в данной версии не используется, поле=0).

  RelocTblOfs (DWORD) - смещение в байтах от начала модуля до таблицы
   коррекции адресов (см. ниже).

  ConfigTblOfs (DWORD) - смещение в байтах от начала модуля до таблицы
   конфигурации (в данной версии не используется, поле=0).

  SectionsOfs (DWORD) - смещение в байтах от начала модуля до начала кодовой
   секции. Модуль может содержать до трех секций - кода (code), неизменяемых
   данных (data) и переменных (vars). Секции располагаются друг за другом,
   и выравнены на границу параграфа (16 байт).

  CodeSectSize (DWORD) - размер кодовой секции в байтах. Если размер не кратен
   16, то он корректируется загрузчиком в сторону увеличения. Для модулей
   данных это поле должно быть равно 0.

  DataSectSize (DWORD) - размер секции данных в байтах. Если размер не кратен
   16, то он корректируется загрузчиком в сторону увеличения.

  VarsSectSize (DWORD) - размер секции переменных в байтах. Если размер не
   кратен 16, то он корректируется загрузчиком в сторону увеличения. Для модулей
   данных это поле должно быть равно 0.

  StackSize (DWORD) - размер стека исполняемого модуля в двойных словах.
   При загрузке исполняемого модуля ему выделяется стек указанного размера.
   Если поле=0, выделения стека не происходит и модуль должен устанавливать
   указатель стека самостоятельно. Для библиотечных модулей и модулей данных
   это поле игнорируется.

  EntryPoint (DWORD) - смещение в байтах от начала кодовой секции до точки
   старта (для исполняемых модулей) или инициализации (для библиотечных
   модулей). Если в библиотечном модуле это значение равно -1 (0FFFFFFFFh), то
   считается, что модуль не имеет точки инициализации. Для модулей данных
   это поле игнорируется.

  ModName - имя модуля. Может содержать до MaxModNameLen-1 символов и должно
   быть дополнено нулем. Набор символов для имени включает большие и маленькие
   буквы латинского алфавита и цифры 0..9; регистр не различается.

  Reserved - зарезервированные поля.


 3. Таблицы имен.

 Таблицы экспортируемых и импортируемых имен имеют одинаковый формат,
 представленный ниже. Разница заключается только в использовании поля SymName.

 ; --- Object type tags ---
 OBJTYPE_NONE		EQU	0
 OBJTYPE_BYTE		EQU	1
 OBJTYPE_WORD		EQU	2
 OBJTYPE_DWORD		EQU	4
 OBJTYPE_FARPTR		EQU	6
 OBJTYPE_QWORD		EQU	8
 OBJTYPE_TWORD		EQU	10
 OBJTYPE_PASCALSTRING	EQU	16
 OBJTYPE_ASCCIZSTRING	EQU	17
 OBJTYPE_NEARPROC	EQU	24
 OBJTYPE_FARPROC	EQU	25
 OBJTYPE_SUBMODULE	EQU	255

 ; --- Sections ---
 SECT_NONE		EQU	0
 SECT_CODE		EQU	1
 SECT_DATA		EQU	2
 SECT_VARS		EQU	3

 ; --- Structure of names table element ---
 struc tNamesTblElem
  Ofs		DD	?				; Offset to object
  Section	DW	?				; Section of object
  TypeTag	DB	?				; Type of object
  Len		DB	?				; Name length
  SymName	DB	MaxSymNameLen dup (?)		; Pascal-type string
 ends


 Таблица имен состоит из набора записей переменной длины. Количество записей
 в таблице неограничено. Конец таблицы индицирует пустая запись, имеющая
 нулевое значение в поле TypeTag.

 Описание полей элемента (записи) таблицы имен:

  Ofs (DWORD) - смещение до объекта в байтах от начала секции, заданной полем
   Section.

  Section (WORD) - секция, в которой находится объект. Поле может принимать
   значения 1,2 или 3 соответственно для кодовой секции, секции данных и
   переменных.

  TypeTag (BYTE) - "ярлык", показывающий тип объекта. Возможные значения этого
   поля кодируют символические константы (OBJTYPE_), приведенные выше. Нулевое
   значение поля индицирует конец таблицы имен.

  Len (BYTE) - длина имени в байтах. Допускаются имена длиной от 1 до 255 байт.

  SymName - собственно имя. Совместно с полем Len имя образует строку
   паскалевского типа (не дополненную нулем). Регистр при обработке имени не
   различается.


 4. Экспортируемые имена.

 Наряду с простым перечислением всех имен, экспортируемых модулем, загрузчик
 операционной системы поддерживает концепцию так называемых субмодулей.
 Субмодули не являются какими-либо программными единицами и не представлены
 в явном виде в файле модуля, они являются лишь удобным средством организации
 экспорта-импорта имен.

 Если в таблице экспорта встречается имя, начинающиеся с точки, то это имя
 интерпретируется загрузчиком как начало объявления нового субмодуля. Все
 последующие имена, перечисленные после этого объявления, до обнаружения
 следующего имени с точкой в начале считаются экспортируемыми из объявленного
 субмодуля. Если встречается имя, состоящее лишь из одной точки, то все
 последующие имена считаются экспортируемыми из модуля.

 Например, если в таблице имен экспорта перечислены следующие имена:

            GetDate
            GetTime
            .filesystem
            Open
            Close
            .mm
	    Alloc
	    Free
            .
            GetSysInfo
            <пустая запись>,

 это означает, что имена GetDate, GetTime и GetSysInfo экспортируются из
 модуля, Open и Close - из субмодуля FILESYSTEM, а Alloc и Free - из
 субмодуля MM. В дальнейшем показано применение субмодулей при построении
 таблиц импорта.

 Внутри каждого субмодуля имена не обязаны быть уникальными, т.е. возможно
 объявление одинаковых имен в разных субмодулях.


 5. Импортируемые имена.

 Первым именем в таблице импортируемых имен обязательно должно быть имя
 модуля (возможно с субмодулем), откуда будут импортированы объявленные
 имена. Имя модуля предваряется символом '$'. В дальнейшем, если среди
 имен встречается имя с символом '$' в первой позиции, то оно считается
 новым именем модуля, откуда будут импортированы последующие имена.

 Например, если в таблице перечислены следующие имена:

            $KERNEL
	    GetDate
 	    GetTime
	    GetSysInfo
	    $KERNEL.Filesystem
	    Open
	    Close
	    $KERNEL.MM
	    Alloc
	    Free
	    <пустая запись>,

 импортируются имена GetDate, GetTime и GetSysInfo из модуля Kernel, Open и
 Close - из субмодуля Filesystem модуля KERNEL и Alloc и Free из субмодуля
 MM этого же модуля.


 6. Таблица коррекции адресов.

 Таблица коррекции адресов состоит из неограниченного количества записей
 фиксированной длины. Эта таблица предназначена для коррекции адресов в
 программе при ее перемещении в адресном пространстве.

 Компоновщик при создании модуля настраивает смещения внутри каждой секции
 так, если бы все секции находились непосредственно друг за другом и начало
 кодовой секции располагалось по адресу 0. Задачей загрузчика операционной
 системы при размещении модуля в памяти является настройка адресов, указанных
 в таблице коррекции, на действительные адреса, т.е. на адреса, по которым
 модуль загружен в память.

 Формат записи таблицы коррекции показан ниже. Конец таблицы индицируется
 специальной пустой записью, имеющей 0 в поле Section.

 ; --- Structure of relocation table element ---
 struc tRelTblElem
  Ofs		DD	?				; Offset to target
  Section	DW	?				; Section of target
  TargSize	DB	?				; Size of target
  Flags		DB	?				; Flags
  Reserved	DB	?				; Reserved
 ends

 Описание полей элемента (записи) таблицы коррекции:

  Ofs (DWORD) - смещение в байтах от начала секции, указанной в поле Section,
   до целевого адреса.

  Section (WORD) - секция, в которой находится целевой адрес. Значения такие
   же, как и в таблице имен. Нулевое значение означает конец таблицы.

  TargSize (BYTE) - размер целевого адреса. Всегда должен быть установлен в 4.

  Flags (BYTE) - битовые флаги. В данной версии используется только бит 0 поля
   Flags. Если он установлен, это означает, что целевой адрес должен быть
   проинициализирован загрузчиком на корректный адрес импортируемого объекта.
   В файле модуля целевой адрес содержит адрес записи в таблице имен импорта
   (адрес отсчитывается по отношению к началу таблицы). Например, если целевой
   адрес равен 73h, загрузчик считывает в таблице импортируемых имен запись по
   смещению 73h от начала таблицы, считывает имя из этой записи и ищет его в
   требуемом модуле. Если имя найдено, загрузчик заполняет целевой адрес
   корректным адресом импортированного обьекта. Если же имя не найдено,загрузчик
   помещает по этому адресу адрес специальной процедуры обработки ошибок.

  Reserved - зарезервированное поле.


--------------------------------------------------------------------------------

    RadiOS Programmer's Manual                                 12 Jul 1999

--------------------------------------------------------------------------------
